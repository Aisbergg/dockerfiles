<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE policymap [
<!ELEMENT policymap (policy)+>
<!ELEMENT policy (#PCDATA)>
<!ATTLIST policy domain (delegate|coder|filter|path|resource) #IMPLIED>
<!ATTLIST policy name CDATA #IMPLIED>
<!ATTLIST policy rights CDATA #IMPLIED>
<!ATTLIST policy pattern CDATA #IMPLIED>
<!ATTLIST policy value CDATA #IMPLIED>
]>
<!--

  Configure ImageMagick policies.

  Domains include system, delegate, coder, filter, path, or resource.

  Rights include none, read, write, execute and all.  Use | to combine them,
  for example: "read | write" to permit read from, or write to, a path.

  Use a glob expression as a pattern.

  Suppose we do not want users to process MPEG video images:

    <policy domain="delegate" rights="none" pattern="mpeg:decode" />

  Here we do not want users reading images from HTTP:

    <policy domain="coder" rights="none" pattern="HTTP" />

  Lets prevent users from executing any image filters:

    <policy domain="filter" rights="none" pattern="*" />

  The /repository file system is restricted to read only.  We use a glob
  expression to match all paths that start with /repository:

    <policy domain="path" rights="read" pattern="/repository/*" />

  Lets prevent users from executing any image filters:

    <policy domain="filter" rights="none" pattern="*" />

  Any large image is cached to disk rather than memory:

    <policy domain="resource" name="area" value="1GP"/>

  Define arguments for the memory, map, area, width, height and disk resources
  with SI prefixes (.e.g 100MB).  In addition, resource policies are maximums
  for each instance of ImageMagick (e.g. policy memory limit 1GB, -limit 2GB
  exceeds policy maximum so memory limit is 1GB).

  Rules are processed in order.  Here we want to restrict ImageMagick to only
  read or write a small subset of proven web-safe image types:

    <policy domain="delegate" rights="none" pattern="*" />
    <policy domain="coder" rights="none" pattern="*" />
    <policy domain="coder" rights="read|write" pattern="{GIF,JPEG,PNG,WEBP}" />
-->
<policymap>
  <!-- For informations about the variables see: https://www.imagemagick.org/script/resources.php -->
  <!-- Security related informations: https://www.imagemagick.org/discourse-server/viewtopic.php?t=26801 -->
  <policy domain="resource" name="memory" value="{{ IMAGEMAGICK_MEMORY }}"/>
  <policy domain="resource" name="map" value="{{ IMAGEMAGICK_MAP }}"/>
  <policy domain="resource" name="width" value="{{ IMAGEMAGICK_WIDTH }}"/>
  <policy domain="resource" name="height" value="{{ IMAGEMAGICK_HEIGHT }}"/>
  <policy domain="resource" name="area" value="{{ IMAGEMAGICK_AREA }}"/>
  <policy domain="resource" name="disk" value="{{ IMAGEMAGICK_DISK }}"/>
  <policy domain="resource" name="file" value="{{ IMAGEMAGICK_FILE }}"/>
  <policy domain="resource" name="thread" value="{{ IMAGEMAGICK_THREAD }}"/>
  <policy domain="resource" name="throttle" value="{{ IMAGEMAGICK_THROTTLE }}"/>
  <policy domain="resource" name="time" value="{{ IMAGEMAGICK_TIME }}"/>
  <policy domain="system" name="precision" value="{{ IMAGEMAGICK_PRECISION }}"/>
  <policy domain="system" name="memory-map" value="anonymous"/>
  <policy domain="cache" name="memory-map" value="anonymous"/>
  <policy domain="system" name="shred" value="1"/>
  <policy domain="cache" name="shared-secret" value="{{ env.IMAGEMAGICK_SHARED_SECRET }}" stealth="true"/>

  <!-- Disable all coders: Requires ImageMagick version 7.0.4-7 -->
  <!-- <policy domain="delegate" rights="none" pattern="*" />
  <policy domain="coder" rights="none" pattern="*" /> -->

{%- set enabled_coders = [] %}
{%- for item in IMAGEMAGICK_ENABLED_CODERS.split(',') %}
  {%- if enabled_coders.append(item | trim) %}{% endif %}
{%- endfor %}
{%- set all_coders = ["EPHEMERAL", "HTTP", "HTTPS", "MVG", "MSL", "TEXT", "SHOW", "WIN", "PLT", "BGR", "BMP", "BRAILLE", "CALS", "CMYK", "DDS", "DNG", "DOT", "EPT", "EPT", "FAX", "FAX", "FITS", "GIF", "GRADIENT", "HTML", "ICON", "INLINE", "JBIG", "JP2", "JPEG", "MAGICK", "META", "MPEG", "MPR", "PCD", "PCX", "PDF", "PICT", "PLASMA", "PNG", "PNM", "PS", "PS2", "PS3", "PSD", "RAW", "RGB", "SIXEL", "SUN", "SVG", "TGA", "TIFF", "TTF", "TXT", "URL", "UYVY", "VIFF", "WMF", "XC", "XPM", "XTRN", "YCbCr"] %}

{% set vars = {'is_enabled': False} %}
{%- for coder in all_coders %}
  {%- for enabled_coder in enabled_coders %}
    {%- if coder == enabled_coder and vars.update({'is_enabled': True}) %}{%- endif %}
  {%- endfor %}
  {%- if not vars.is_enabled %}
  <policy domain="coder" rights="none" pattern="{{ coder }}" />
  {%- endif %}
  {%- if vars.update({'is_enabled': False}) %}{% endif %}
{%- endfor %}

  <!-- Enable specified coders -->
  <policy domain="coder" rights="read | write" pattern="{{ '{' }}{{ enabled_coders | join(',') }}{{ '}' }}" />
</policymap>
