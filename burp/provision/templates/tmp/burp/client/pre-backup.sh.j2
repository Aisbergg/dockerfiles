#!/bin/bash
# container_managed=true                                                       #
#                                                                              #
# NOTE: by default this file is automatically generated on container startup.  #
# To disable the autogeneration simply change the first line of this file to   #
# 'container_managed=false'                                                    #
################################################################################

umask 0077
tmp_backup_dir="/tmp/backup"
mkdir -p "$tmp_backup_dir"

{% if MYSQL_DATABASES|length > 0 -%}
##
## Backup MySQL Databases
##

dump_dir="$tmp_backup_dir/mysql_dumps"
mkdir -p "$dump_dir"

mysql_host="{{ MYSQL_HOST }}"
mysql_port="{{ MYSQL_PORT }}"
mysql_user="{{ MYSQL_USER }}"
mysql_password="{{ MYSQL_PASSWORD }}"

{% for mysql_database_name in MYSQL_DATABASES %}
mysql-dump -h "$mysql_host" -P "$mysql_port" -u "$mysql_user" -p "$mysql_password" {{ mysql_database_name }} "$dump_dir/{{ mysql_database_name }}.sql"
{%- endfor %}
{%- endif %}

##
## Create Restore Information
##

cat > "$tmp_backup_dir/post-restore.sh" <<EOF
#!/bin/bash
{% if MYSQL_DATABASES|length > 0 -%}
mysql_host="{{ MYSQL_HOST }}"
mysql_port="{{ MYSQL_PORT }}"
mysql_user="{{ MYSQL_USER }}"
mysql_password="{{ MYSQL_PASSWORD }}"

{% for mysql_database_name in MYSQL_DATABASES %}
mysql-restore -h "$mysql_host" -P "$mysql_port" -u "$mysql_user" -p "$mysql_password" {{ mysql_database_name }} "$dump_dir/{{ mysql_database_name }}.sql"
{%- endfor %}

rm -rf "$dump_dir
{%- endif %}"
EOF
chmod 700 "$tmp_backup_dir/post-restore.sh"
