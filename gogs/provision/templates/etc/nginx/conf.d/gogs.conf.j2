# autogen true

#######################################
#             Upstream                #
#######################################

upstream gogs {
    server 127.0.0.1:3000;
}

#######################################
#            HTTP & HTTPS             #
#######################################

server {
    listen                 80;
    listen                 [::]:80;
    listen                 443 ssl {{ 'http2' if NGINX_HTTP_VERSION == "2.0" }} default_server;
    listen                 [::]:443 ssl {{ 'http2' if NGINX_HTTP_VERSION == "2.0" }};
    {% if DOMAINNAMES is defined -%}
    server_name            {% for domain in DOMAINNAMES %} {{ domain }}{% endfor %};
    {%- endif %}

    # Let's Encrypt challenge response uri
    location ^~ /.well-known/acme-challenge {
        default_type "text/plain";
        root /var/www/letsencrypt-challenge-response;
    }

    location / {
        {% if NGINX_TLS_ONLY -%}
        if ($real_scheme != "https") {
            return 301 https://$host$request_uri;
        }
        {%- endif %}

        # prevent SYN-flood
        # limit concurrent connections per ip
        limit_conn conn_limit_per_ip {{ NGINX_CONN_LIMIT_PER_IP }};
        # limit requests per second per ip
        limit_req zone=req_limit_per_ip burst={{ NGINX_REQ_LIMIT_PER_IP_BURST }};

        # pass request to gogs server
        proxy_set_header     X-Forwarded-Proto   $real_scheme;
        #proxy_redirect       off;
        proxy_read_timeout   {{ NGINX_PROXY_READ_TIMEOUT }};
        proxy_pass           http://gogs;
        proxy_set_header     Host                $http_host;
        proxy_set_header     X-Real-IP           $proxy_add_x_forwarded_for;
        proxy_set_header     X-Forwarded-For     $proxy_add_x_forwarded_for;
        # strip 'Proxy' header (see httpoxy vulnerability)
        proxy_set_header     Proxy               "";
        proxy_pass_header    Server;
        proxy_buffering      off;
        proxy_http_version   1.1;  # recommended with keepalive connections
        # WebSocket proxying - from http://nginx.org/en/docs/http/websocket.html
        proxy_set_header     Upgrade             $http_upgrade;
        proxy_set_header     Connection          $connection_upgrade;
    }
}

# we're in the http context here
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}
